# 网络流控

## 目标

1.	能够有效利用网络带宽。
2.	能够感知网络带宽的变化，当网络拥塞时，能够感知到。
3.	能够在网络拥塞时，及时调整发送流量，适应网络拥塞。
4.	当网络由拥塞变为缓解时，能及时放开发送流量，以适应当前带宽。
5.	使发送流量尽量围绕网络带宽上下波动，尽量使波动平滑，避免出现波形尖刺的现象。

## 策略
1. 实时监控丢包个数和发送流量，当有丢包时，实时下调发送流量；
2. 如果当前发送流量超过了本时系（200MS为一个时系）的最大发送流量，本时系停止发送数据，让数据进流控队列，等到下个时系再发送；
3. 每个时系结束时，根据本时系的发送流量，丢包个数，上个时系的丢包个数，对下个时系的最大发送流量进行调整；
4. 对音频数据包透传，不做流控，但计发送流量；
5. 当流量发超时，除音频以外的所有业务数据全部进流控队列，当到下个时系可以发送数据时，从各队列中取出优先级最高的队列，在该队列中取出数据进行发送。
6. 流控总体策略是慢升缓降。


## 流控算法
**算法要点**

1. 当前时系的最大发送流量一定要做实时调整，不能在时系点做调整，为了更加快速的适合网络变化
2. 上调或是下调不是一个固定的值，而是一个固定的百分比，并且这个固定的百分比不能超过一个最大值，要以一个梯度去上调或是下调，目前，上调的百分比是1/32,最大不能超过1/8,下调分情况，百分比可以是1/16和1/8,一个时系内累积不得超过1/4。同时会设定一个时系内的最大发送流量值和最小发送流量值，调整后的最大发送流量值不能超过最大发送流量值，也不能小于最小发送流量值，如果小于就让其等于最小发送流量值，如果大于就让其等于最大发送流量值，百分比是为了让升降更加平滑，而最大发送流量和最小发送流量是为了控制当前流量不超过一个极限值;
3. 下调流量都是实时的触发，当有丢包请求时，立即触发下调动作，实时下调流量分以下两种情况：
4. a)当该时系内总的丢包个数 <=2时，每丢一个包，如果上个时系没有降幅或是升幅， 当前最大发送流量 = 当前最大发送流量 – 当前最大发送流量 * （1/16）。当丢第二个包时，当前最大发送流量 = 当前最大发送流量 – 当前最大发送流量* （1/16）。下调后的值与设定的最小发送流量对比，如果比设定的最小发送流量值小，就用设定的最小发送流量做为下个时系的最大发送流量。

b)当该时系内总的丢包个数 >2 时，认为网络状况恶化，把当前最大发送流量降1/8, 当前最大发送流量 = 当前最大发送流量 – 当前最大发送流量 * （1/8）。当丢包数为3时，第三个丢包来时，整个流量已经下调了1/4,按照算法每个时系累积下调不能超过1/4，所以当第4个丢包及以后的丢包来临时，都不会再下调最大发送流量了。下调后的值与设定的最小发送流量对比，如果比设定的最小发送流量值小，就用设定的最小发送流量做为下个时系的最大发送流量。
4. 上调流量都是在时系点做调整，当丢包情况有好转时会在时系点对下调后的最大发送流量进行微上调；当丢包加重时，会根据情况在时系点对最大发送流量进行微下调；当连续没有没丢包时，会在时系点对最大发送流量进行大幅上调。针对上面的情况细分为下面几种情况，其中c,d,e是针对（上次丢包个数>=本次丢包个数）的情况。

c)当上次有丢包，本次丢包个数为0时，认为网络已经不丢包，应该上调最大发送流量，下个时系的最大发送量= 本次实际发送流量 + （上次丢包个数 – 本次丢包个数）* (1/32) * 本次实际发送流量。上调后的值与设定的最大发送流量对比，如果比设定的最大发送流量值大，就用设定的最大发送流量做为下个时系的最大发送流量。

d)当上次有丢包，本次也有丢包，并且（上次丢包个数 – 本次丢包个数)> 2 ,认为现在的网络有明显好转的迹象，也要上调最大发送流量，下个时系的最大发送流量的计算与情况a)相同，即下个时系的最大发送量= 本次实际发送流量 + （上次丢包个数 – 本次丢包个数）* (1/32) * 本次实际发送流量。上调后的值与设定的最大发送流量对比，如果比设定的最大发送流量值大，就用设定的最大发送流量做为下个时系的最大发送流量。

e)当上次有丢包，本次也有丢包，但是 （上次丢包个数 – 本次丢包个数）<=2,认为现在的网络好转不是很明显，丢包个数并没有减少太多，此时的流量还是应该维持下调的状态，因为是实时降流量，所以当前时系最大发送流量已经实时的下调过了，下个时系的最大发送流量以本次实时下降后的最大流量为准。

f)当没有丢包时，（相临两个时系的丢包个数都为0），认为网络状况非常好，如果 （上次最大发送流量 - 本次实际发送流量） <= 10 kb,说明本次实际发送流量与最大发送流量很逼近，需要大幅上调最大发送流量了，下个时系的最大发送流量 = 本次实际发送流量 + 本次实际发送流量 * （1/8） ；如果  （上次最大发送流量 - 本次实际发送流量）> 10kb, 说明实际发送流量与最大发送流量相差很大，无需上调最大发送流量，令下个时系的最大发送量 = 本次最大发送流量。

g)当丢包情况加重时，（本次丢包个数 > 上次丢包个数），本次最大发送流量已经实时下调过了，在本时系点进行下个时系的最大发送流量调整时，比较当前已经发送流量与当前时系最大发送流量，如果 （当前实际发送流量 < 当前时系最大发送流量）说明我们实时下降的力度不够，没有达到效果，下调后的最大发送流量仍然比当前实际发送流量大，并且网络还存在丢包，所以要在当前实际发送流量的基础上再下调一个幅度，下个时系的最大发送量 = 本次实际发送流量 – 本次实际发送流量* （1/16），这里会忽略一个时系内下调不超过1/4的情况。下调后的值与设定的最小发送流量对比，如果比设定的最小发送流量值小，就用设定的最小发送流量做为下个时系的最大发送流量。

5. 该算法会忽略网络持续保持恒定丢包率的情况。

6. 区分末包请求和真实丢包请求，对于末包请求不在流控算法内处理，对于非末包请求是要触发丢包请求降流量操作的。
